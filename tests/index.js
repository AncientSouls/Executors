'use strict';var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if('value'in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _chai=require('chai');var _lib=require('../lib');var _lib2=_interopRequireDefault(_lib);var _ancientGraph=require('ancient-graph');var _async=require('async');var _async2=_interopRequireDefault(_async);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}require('source-map-support').install();function generateGraph(){var collection=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];return new _ancientGraph.ObjectGraph(collection,{id:'id',childs:'childs'})};function generateFunicular(){var graph=arguments.length>0&&arguments[0]!==undefined?arguments[0]:generateGraph();var funicular=new _lib2.default;var OldCarriage=funicular.Carriage;funicular.Carriage=function(_OldCarriage){_inherits(_class,_OldCarriage);function _class(){_classCallCheck(this,_class);return _possibleConstructorReturn(this,(_class.__proto__||Object.getPrototypeOf(_class)).apply(this,arguments))}_createClass(_class,[{key:'subscribe',value:function subscribe(callback){var _this2=this;this.unsubscribe=function(){updateStop();removeStop()};var updateStop=graph.on('update',function(oldData,newData){if(newData.id==_this2.name)_this2.updated(newData)});var removeStop=graph.on('remove',function(oldData,newData){if(newData.id==_this2.name)_this2.removed()});graph.get(this.name,undefined,function(error,data){_this2.fetched(error,data);callback(error)})}},{key:'getChildsNames',value:function getChildsNames(){this.childs=this.data.childs}}]);return _class}(OldCarriage);return funicular};describe('AncientSouls/Funicular',function(){it('new Funicular',function(){generateFunicular()});it('new funicular.Carriage',function(){var funicular=generateFunicular();var a=new funicular.Carriage('a');_chai.assert.deepProperty(funicular,'carriages.a.'+a.id)});it('funicular.mount',function(done){var graph=generateGraph();graph.insert({id:'a'});var funicular=generateFunicular(graph);funicular.mount('a',function(error,a){_chai.assert.ifError(error);_chai.assert.instanceOf(a,_lib.Carriage);_chai.assert.deepProperty(a,'data.id');_chai.assert.equal(a.data.id,'a');_chai.assert.equal(a.stage,'mounted');done()})});it('funicular.mount with childs',function(done){var graph=generateGraph();graph.insert({id:'a',childs:['b']});graph.insert({id:'b'});var funicular=generateFunicular(graph);funicular.mount('a',function(error,a){_chai.assert.ifError(error);_chai.assert.instanceOf(a,_lib.Carriage);_chai.assert.deepProperty(a,'data.id');_chai.assert.equal(a.data.id,'a');_chai.assert.equal(a.stage,'mounted');_chai.assert.deepProperty(a,'_childs.b');_chai.assert.instanceOf(a._childs.b,_lib.Carriage);_chai.assert.deepProperty(a,'_childs.b._parents.a');_chai.assert.equal(a._childs.b._parents.a,a);_chai.assert.equal(a._childs.b.stage,'mounted');done()})});it('carriage.unmount',function(done){var graph=generateGraph();graph.insert({id:'a'});var funicular=generateFunicular(graph);funicular.mount('a',function(error,a){a.unmount(function(){_chai.assert.notDeepProperty(funicular,'carriages.a.'+a.id);_chai.assert.equal(a.stage,'unmounted');done()})})});it('carriage.unmount with childs',function(done){var graph=generateGraph();graph.insert({id:'a',childs:['b']});graph.insert({id:'b'});var funicular=generateFunicular(graph);funicular.mount('a',function(error,a){var b=a._childs.b;a.unmount(function(error){_chai.assert.ifError(error);_chai.assert.notDeepProperty(funicular,'carriages.a.'+a.id);_chai.assert.notDeepProperty(funicular,'carriages.b.'+b.id);_chai.assert.equal(a.stage,'unmounted');_chai.assert.equal(b.stage,'unmounted');done()})})});it('carriage.mountRoot and unmountRoot',function(done){var graph=generateGraph();graph.insert({id:'a',childs:['b']});graph.insert({id:'b'});var funicular=generateFunicular(graph);funicular.mountRoot('a',function(error,a,unmountRootA){var b=a._childs.b;a.unmount(function(error){_chai.assert.ifError(error);_chai.assert.instanceOf(a,_lib.Carriage);_chai.assert.deepProperty(a,'data.id');_chai.assert.equal(a.data.id,'a');_chai.assert.equal(a.stage,'mounted');_chai.assert.deepProperty(a,'_childs.b');_chai.assert.instanceOf(a._childs.b,_lib.Carriage);_chai.assert.deepProperty(a,'_childs.b._parents.a');_chai.assert.equal(a._childs.b._parents.a,a);_chai.assert.equal(a._childs.b.stage,'mounted');unmountRootA(function(error){_chai.assert.ifError(error);_chai.assert.notDeepProperty(funicular,'carriages.a.'+a.id);_chai.assert.notDeepProperty(funicular,'carriages.b.'+b.id);_chai.assert.equal(a.stage,'unmounted');_chai.assert.equal(b.stage,'unmounted');done()})})})});it('update with remaunting',function(done){var graph=generateGraph();graph.insert({id:'a',childs:['b']});graph.insert({id:'b'});var funicular=generateFunicular(graph);var OldCarriage=funicular.Carriage;funicular.Carriage=function(_OldCarriage2){_inherits(_class2,_OldCarriage2);function _class2(){_classCallCheck(this,_class2);return _possibleConstructorReturn(this,(_class2.__proto__||Object.getPrototypeOf(_class2)).apply(this,arguments))}_createClass(_class2,[{key:'updated',value:function updated(newData){var _this4=this;funicular.mount(this.name,function(error,newCarriage){_this4.remountedCarriage=newCarriage;newCarriage.mountedCallbacks=_this4.mountedCallbacks;_this4.mountedCallbacks=[];newCarriage.unmountedCallbacks=_this4.unmountedCallbacks;_this4.moveRoots(newCarriage);_this4.unmount();_this4.unmountedCallbacks=[]})}}]);return _class2}(OldCarriage);funicular.mountRoot('a',function(error,a,unmountRoot){graph.update('a',{$set:{childs:['b']}})},function(a){_chai.assert.equal(a.stage,'unmounted');_chai.assert.instanceOf(a.remountedCarriage,_lib.Carriage);_chai.assert.equal(a.remountedCarriage.stage,'mounted');done()})});it('multiple maunting processes with one carriage in result',function(done){var graph=generateGraph();graph.insert({id:'a',childs:['b']});graph.insert({id:'b'});var funicular=generateFunicular(graph);funicular._mount=funicular.mount;funicular.mount=function(name,mountedCallback,unmountedCallback){var carriage;if(this.carriages[name]){for(var c in this.carriages[name]){carriage=this.carriages[name][c]}}if(!carriage){funicular._mount.apply(funicular,arguments)}else{if(carriage.stage!='mounted'){if(mountedCallback)carriage.mountedCallbacks.push(mountedCallback)}else mountedCallback(undefined,carriage);if(carriage.stage!='unmounted'){if(unmountedCallback)carriage.unmountedCallbacks.push(unmountedCallback)}}};var OldCarriage=funicular.Carriage;funicular.Carriage=function(_OldCarriage3){_inherits(_class3,_OldCarriage3);function _class3(){_classCallCheck(this,_class3);return _possibleConstructorReturn(this,(_class3.__proto__||Object.getPrototypeOf(_class3)).apply(this,arguments))}_createClass(_class3,[{key:'unsafeMount',value:function unsafeMount(callback){var _this6=this;setTimeout(function(){_get(_class3.prototype.__proto__||Object.getPrototypeOf(_class3.prototype),'unsafeMount',_this6).call(_this6,callback)},100)}},{key:'updated',value:function updated(newData){var _this7=this;this.funicular._mount(this.name,function(error,newCarriage){_this7.remountedCarriage=newCarriage;newCarriage.mountedCallbacks=_this7.mountedCallbacks;_this7.mountedCallbacks=[];newCarriage.unmountedCallbacks=_this7.unmountedCallbacks;_this7.moveRoots(newCarriage);_this7.unmount();_this7.unmountedCallbacks=[]})}}]);return _class3}(OldCarriage);var counter=0;funicular.mountRoot('a',function(error,a,unmountRoot){counter++});funicular.mountRoot('a',function(error,a,unmountRoot){graph.update('a',{$set:{childs:['b']}})},function(a){_chai.assert.equal(counter,1);_chai.assert.equal(a.stage,'unmounted');_chai.assert.instanceOf(a.remountedCarriage,_lib.Carriage);_chai.assert.equal(a.remountedCarriage.stage,'mounted');done()})})});
//# sourceMappingURL=index.js.map