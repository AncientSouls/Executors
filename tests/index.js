'use strict';var _typeof=typeof Symbol==='function'&&typeof Symbol.iterator==='symbol'?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==='function'&&obj.constructor===Symbol&&obj!==Symbol.prototype?'symbol':typeof obj};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if('value'in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var _chai=require('chai');var _lib=require('../lib');var _ancientGraph=require('ancient-graph');var _async=require('async');var _async2=_interopRequireDefault(_async);var _each=require('async/each');var _each2=_interopRequireDefault(_each);var _lodash=require('lodash');var _lodash2=_interopRequireDefault(_lodash);var _colors=require('colors');var _colors2=_interopRequireDefault(_colors);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return Array.from(arr)}}require('source-map-support').install();function log(deep,item){var _console;var replaced=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;(_console=console).log.apply(_console,_toConsumableArray(_lodash2.default.repeat(!replaced?'-':' ',deep)).concat([item.name||'unnamed','('+item.index+')',_colors2.default[item.isMounted?'bold':'gray']('isMounted'),_colors2.default[item.isUnmounted?'bold':'gray']('isUnmounted'),_colors2.default[item.isReplaced?'bold':'gray']('isReplaced'),'[',_lodash2.default.map(item.childs,function(c){return c.name+' ('+c.index+')'}),']','[',_lodash2.default.map(item.parents,function(c){return'('+c.index+')'}),']']));if(item.isReplaced){log(deep,item.getActive(),true)}}/**
 * @description
 * Example of Item extension.
 * Support for two query types:
 * * As function `lodash.find` selector for memory.
 * * As object with childs queries by local names.
 */var CustomItem=function(_Item){_inherits(CustomItem,_Item);function CustomItem(){_classCallCheck(this,CustomItem);return _possibleConstructorReturn(this,(CustomItem.__proto__||Object.getPrototypeOf(CustomItem)).apply(this,arguments))}_createClass(CustomItem,[{key:'getResult',// With this example, access to result provide method getResult.
value:function getResult(){return this.result}},{key:'preparation',value:function preparation(){var _this2=this;// With this examples, i use field exports for executed data.
this.result={};setTimeout(function(){if(typeof _this2.query=='function'){// is single named item (currect or incorrect without name)
_this2.data=_lodash2.default.find(_this2.manager._memory,_this2.query);if(_this2.data){// if data founded
if(_this2.name){// if global name sended, it currect item
for(var c in _this2.data.childs){_this2.prepareChild(c,undefined,_this2.data.childs[c])}_this2.result=_this2.data;_this2.prepared(undefined);// done prepare
}else{// incorrect item without name
_this2.replace(_this2.data.name,_this2.query,_this2.data);// reprepare new item with name and equal query and already existed data
}}else{// if data not founded
_this2.prepared('data-not-founded')}}else if(_typeof(_this2.query)=='object'){// is unnamed item for get childs named items
// if this query used for named item, it... on your conscience
for(var c in _this2.query){_this2.prepareChild(c,undefined,_this2.query[c])}_this2.result=_this2.childs;_this2.prepared(undefined);// done prepare
}else{throw new Error('wrong query type')}},this.manager._timeoutOfPreparation)}},{key:'mounting',value:function mounting(){var _this3=this;setTimeout(function(){(0,_each2.default)(_this3.childs,function(child,next){child.mount(function(){next()})},function(){return _this3.mounted(undefined)})},this.manager._timeoutOfMounting)}},{key:'unmounting',value:function unmounting(){var _this4=this;setTimeout(function(){_get(CustomItem.prototype.__proto__||Object.getPrototypeOf(CustomItem.prototype),'unmounting',_this4).call(_this4)},this.manager._timeoutOfUnmounting)}},{key:'childReplaced',value:function childReplaced(localName,oldChild,newChild){var _this5=this;this.replace(this.name,this.query,this.data).mount(function(error,item){_this5.unmount()})}}]);return CustomItem}(_lib.Item);function generateManager(memory){var timeoutOfPreparation=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var timeoutOfMounting=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var timeoutOfUnmounting=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var manager=new _lib.Manager(CustomItem);manager._memory=memory;manager._timeoutOfPreparation=timeoutOfPreparation;manager._timeoutOfMounting=timeoutOfMounting;manager._timeoutOfUnmounting=timeoutOfUnmounting;return manager};describe('AncientSouls/Funicular',function(){describe('check methods',function(){describe('manager.get',function(){it('should return constructed item and register global item if name exists',function(){var memory={a:{name:'a'}};var manager=generateManager(memory,0,0,0);var a1=manager.get('a',function(data){return data.name=='a'});_chai.assert.equal(a1,manager._items.a);_chai.assert.equal(a1.name,'a');var a2=manager.get('a',function(data){return data.name=='a'});_chai.assert.equal(a1,a2)})});describe('item.prepare',function(){it('should run preparation for item or add once listener for prepared event',function(done){var memory={a:{name:'a'}};var manager=generateManager(memory,5,0,0);var a1=manager.get('a',function(data){return data.name=='a'});_chai.assert.equal(a1.isPrepared,undefined);a1.prepare(function(error,a2){_chai.assert.equal(a1,a2);_chai.assert.equal(a2.isPrepared,true);a2.prepare(function(error,a3){_chai.assert.equal(a2,a3);_chai.assert.equal(a3.isPrepared,true);done()})});_chai.assert.equal(a1.isPrepared,false)})});describe('item.prepareChild',function(){it('should return item, and after parent fully, run preparation for all childs called with prepareChild',function(done){var memory={a:{name:'a',childs:{x:function x(d){return d.name=='b'}}},b:{name:'b'}};var manager=generateManager(memory,0,0,0);var a1=manager.get('a',function(data){return data.name=='a'});_chai.assert.equal(a1.isPrepared,undefined);a1.prepare(function(error,a2){_chai.assert.equal(a1,a2);_chai.assert.equal(a2.isPrepared,true);_chai.assert.equal(a1,manager._items.a);_chai.assert.equal(a1.childs.x,manager._items.b);_chai.assert.equal(a1.childs.x.isPrepared,true);done()})})});describe('item.mount',function(){it('should prepare if not prepared, run mounting for item or add once listener for mounted event',function(done){var memory={a:{name:'a',childs:{x:function x(d){return d.name=='b'}}},b:{name:'b'}};var manager=generateManager(memory,0,0,0);var a1=manager.get('a',function(data){return data.name=='a'});_chai.assert.equal(a1.isPrepared,undefined);_chai.assert.equal(a1.isMounted,undefined);a1.mount(function(error,a2){_chai.assert.equal(a1,a2);_chai.assert.equal(a2.isPrepared,true);_chai.assert.equal(a2.isMounted,true);_chai.assert.equal(a1,manager._items.a);_chai.assert.equal(a1.childs.x,manager._items.b);_chai.assert.equal(a1.childs.x.isPrepared,true);_chai.assert.equal(a1.childs.x.isMounted,true);done()})})});describe('item.unmount',function(){it('should unmount childs',function(done){var memory={a:{name:'a',childs:{x:function x(d){return d.name=='b'}}},b:{name:'b'}};var manager=generateManager(memory,0,0,5);var a1=manager.get('a',function(data){return data.name=='a'});_chai.assert.equal(a1.isPrepared,undefined);_chai.assert.equal(a1.isMounted,undefined);a1.mount(function(error,a2){a2.unmount(function(error,a3){_chai.assert.equal(a1,a3);_chai.assert.equal(a3.isPrepared,true);_chai.assert.equal(a3.isMounted,true);_chai.assert.equal(a3.isUnmounted,true);_chai.assert.equal(a1,manager._items.a);_chai.assert.equal(a1.childs.x,manager._items.b);_chai.assert.equal(a1.childs.x.isPrepared,true);_chai.assert.equal(a1.childs.x.isMounted,true);_chai.assert.notEqual(a1.childs.x.isUnmounted,true);setTimeout(function(){_chai.assert.equal(a1.childs.x.isUnmounted,true);done()},10)})})});it('should unmount unnamed items',function(done){var memory={a:{name:'a',childs:{x:function x(d){return d.name=='b'}}},b:{name:'b'}};var manager=generateManager(memory,0,0,0);var root1=manager.get(undefined,{z:function z(data){return data.name=='a'}});_chai.assert.equal(root1.isPrepared,undefined);_chai.assert.equal(root1.isMounted,undefined);root1.mount(function(error,root2){_chai.assert.equal(root1,root2);_chai.assert.equal(root2.isPrepared,true);_chai.assert.equal(root2.isMounted,true);_chai.assert.equal(root2.childs.z,manager._items.a);_chai.assert.equal(root2.childs.z.childs.x,manager._items.b);_chai.assert.equal(root2.childs.z.isPrepared,true);_chai.assert.equal(root2.childs.z.isMounted,true);_chai.assert.equal(root2.childs.z.childs.x.isPrepared,true);_chai.assert.equal(root2.childs.z.childs.x.isMounted,true);_chai.assert.equal(root2.childs.z.childs.x,manager._items.b);_chai.assert.lengthOf(Object.keys(manager._items),2);root2.unmount(function(error,root3){_chai.assert.equal(root1,root3);setTimeout(function(){_chai.assert.equal(root2.isUnmounted,true);_chai.assert.equal(root2.childs.z.isUnmounted,true);_chai.assert.equal(root2.childs.z.childs.x.isUnmounted,true);done()},10)})})});it('should unmount items only if all parents are unmounted',function(done){var memory={a:{name:'a',childs:{x:function x(d){return d.name=='c'}}},b:{name:'b',childs:{x:function x(d){return d.name=='c'}}},c:{name:'c'}};var manager=generateManager(memory,0,0,0);var a1=manager.get('a',function(data){return data.name=='a'});var b1=manager.get('b',function(data){return data.name=='b'});a1.mount(function(error,a2){b1.mount(function(error,b2){a2.unmount(function(error,a3){setTimeout(function(){_chai.assert.equal(a1.isUnmounted,true);_chai.assert.notEqual(b1.isUnmounted,true);_chai.assert.notEqual(a1.childs.x.isUnmounted,true);_chai.assert.lengthOf(Object.keys(a1.childs.x.parents),1);b2.unmount(function(error,b3){_chai.assert.notEqual(a1.childs.x.isUnmounted,true);_chai.assert.lengthOf(Object.keys(a1.childs.x.parents),0);done()})},10)})})})})});describe('item.replace',function(){it('should replace this item without changes',function(done){var memory={a:{name:'a'}};var manager=generateManager(memory,0,0,0);var a1=manager.get('a',function(data){return data.name=='a'});a1.mount(function(error,a2){var a3=a2.replace();_chai.assert.notEqual(a2,a3);_chai.assert.equal(a2.isPrepared,true);_chai.assert.notEqual(a3.isPrepared,true);_chai.assert.notEqual(a3.isMounted,true);done()})});it('should replace this item with already existed other item',function(done){var memory={a:{name:'a'},b:{name:'b'}};var manager=generateManager(memory,0,0,0);var a1=manager.get('a',function(data){return data.name=='a'});var b1=manager.get('b',function(data){return data.name=='b'});a1.mount(function(error,a2){var b2=a2.replace(b1);_chai.assert.notEqual(a2,b2);_chai.assert.equal(a2.isPrepared,true);_chai.assert.notEqual(b2.isPrepared,true);_chai.assert.notEqual(b2.isMounted,true);done()})});it('should replace this item with different name, query and data',function(done){var memory={a:{name:'a'},b:{name:'b'}};var manager=generateManager(memory,0,0,0);var a1=manager.get('a',function(data){return data.name=='a'});var b1=manager.get('b',function(data){return data.name=='b'});a1.mount(function(error,a2){var b2=a2.replace('b',function(d){return d.name=='b'});_chai.assert.notEqual(a2,b2);_chai.assert.equal(a2.isPrepared,true);_chai.assert.notEqual(b2.isPrepared,true);_chai.assert.notEqual(b2.isMounted,true);done()})})})});describe('check concepts',function(){it('lifecicle',function(done){var memory={a:{name:'a',childs:{x:function x(d){return d.name=='b'},y:function y(d){return d.name=='c'}}},b:{name:'b'},c:{name:'c'}};var manager=generateManager(memory,0,0,0);var root0=manager.get(undefined,{a:function a(d){return d.name=='a'}});root0.mount(function(error,root1){var a1=root1.childs.a;var b1=a1.childs.x;var c1=a1.childs.y;_chai.assert.equal(a1,manager._items.a);_chai.assert.equal(b1,manager._items.b);_chai.assert.equal(c1,manager._items.c);_chai.assert.equal(root1.isPrepared,true);_chai.assert.equal(a1.isPrepared,true);_chai.assert.equal(b1.isPrepared,true);_chai.assert.equal(c1.isPrepared,true);_chai.assert.equal(root1.isMounted,true);_chai.assert.equal(a1.isMounted,true);_chai.assert.equal(b1.isMounted,true);_chai.assert.equal(c1.isMounted,true);root1.childs.a.replace().mount(function(error,a){setTimeout(function(){var root2=root1.getActive();_chai.assert.equal(root1.isUnmounted,true);_chai.assert.equal(root1.isReplaced,true);_chai.assert.equal(root2.isMounted,true);_chai.assert.notEqual(root2.isUnmounted,true);_chai.assert.notEqual(root2.isReplaced,true);var a2=a1.getActive();_chai.assert.equal(a1.isUnmounted,true);_chai.assert.equal(a1.isReplaced,true);_chai.assert.equal(a2.isMounted,true);_chai.assert.notEqual(a2.isUnmounted,true);_chai.assert.notEqual(a2.isReplaced,true);_chai.assert.notEqual(b1.isReplaced,true);_chai.assert.notEqual(c1.isReplaced,true);_chai.assert.notEqual(b1.isUnmounted,true);_chai.assert.notEqual(c1.isUnmounted,true);root2.unmount(function(){setTimeout(function(){_chai.assert.equal(root2.isUnmounted,true);_chai.assert.equal(a2.isUnmounted,true);_chai.assert.equal(b1.isUnmounted,true);_chai.assert.equal(c1.isUnmounted,true);done()},10)})},10)})})});describe('registrations',function(){it('should soft unregister global item when unmount method just runned, and rewrite new item when it constructed',function(done){var memory={a:{name:'a'}};var manager=generateManager(memory,0,0,5);var a1=manager.get('a',function(data){return data.name=='a'});a1.mount(function(error,a2){a2.unmount(function(error,a3){// Old version still in _items, until someone not call manager.get method.
_chai.assert.equal(manager._items.a,a1);// After that old item unregister from _items and new registered.
_chai.assert.notEqual(manager.get('a',function(data){return data.name=='a'}),a1);setTimeout(function(){done()},10)})})})});describe('recursions',function(){it('preparation',function(done){var memory={a:{name:'a',childs:{x:function x(d){return d.name=='b'},y:function y(d){return d.name=='c'}}},b:{name:'b'},c:{name:'c',childs:{z:function z(d){return d.name=='a'}}}};var manager=generateManager(memory,0,0,0);var a1=manager.get('a',function(data){return data.name=='a'});a1.prepare(function(){_chai.assert.equal(a1.getResult(),a1.data);_chai.assert.equal(a1.childs.x.getResult(),a1.childs.x.data);_chai.assert.equal(a1.childs.y.getResult(),a1.childs.y.data);_chai.assert.equal(a1.childs.y.childs.z.getResult(),a1.childs.y.childs.z.data);done()})});it('mounting',function(done){var memory={a:{name:'a',childs:{x:function x(d){return d.name=='b'},y:function y(d){return d.name=='c'}}},b:{name:'b'},c:{name:'c',childs:{z:function z(d){return d.name=='a'}}}};var manager=generateManager(memory,0,0,0);var a1=manager.get('a',function(data){return data.name=='a'});a1.mount(function(){_chai.assert.equal(a1.getResult(),a1.data);_chai.assert.equal(a1.childs.x.getResult(),a1.childs.x.data);_chai.assert.equal(a1.childs.y.getResult(),a1.childs.y.data);_chai.assert.equal(a1.childs.y.childs.z.getResult(),a1.childs.y.childs.z.data);done()})})})})});
//# sourceMappingURL=index.js.map