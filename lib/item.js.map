{"version":3,"sources":["../src/lib/item.js"],"names":["require","EventEmitter","counter","Item","manager","name","query","index","data","undefined","isPrepared","isMounted","isUnmounted","isReplaced","_childs","childs","parents","emitter","__emitToSubscription","subscription","eventType","args","Array","prototype","slice","call","arguments","listener","apply","context","localName","globalName","child","get","_registerChild","once","oldChild","newChild","_childReplaced","error","childUnmounted","mount","prepare","childError","_childPrepared","Object","keys","length","childReplaced","Error","callback","preparation","c","emit","getActive","item","_Item","replacedTo","_getActiveCache","shouldMount","mounting","parent","unmount","shouldUnmount","forceUnmount","unmounting","parentUnmounted","unmounted"],"mappings":"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","file":"item.js","sourcesContent":["var { EventEmitter } = require('fbemitter');\n\nvar counter = 1;\n\n/**\n * @class\n */\nclass Item {\n  \n  /**\n   * @constructs Item\n   * @param {Manager} manager\n   * @param {string} name\n   * @param [query]\n   */\n  constructor(manager, name, query) {\n    \n    /**\n     * @type {number}\n     * @protected\n     */\n    this.index = counter++;\n    \n    /**\n     * @type {Manager}\n     * @protected\n     */\n    this.manager = manager;\n    \n    /**\n     * @type {string}\n     * @protected\n     */\n    this.name = name;\n    \n    /**\n     * @protected\n     */\n    this.query = query;\n    \n    /**\n     * @protected\n     */\n    this.data = undefined;\n    \n    /**\n     * @type {boolean=}\n     * @protected\n     */\n    this.isPrepared = undefined;\n    \n    /**\n     * @type {boolean=}\n     * @protected\n     */\n    this.isMounted = undefined;\n    \n    /**\n     * @type {boolean=}\n     * @protected\n     */\n    this.isUnmounted = undefined;\n    \n    /**\n     * @type {boolean=}\n     * @protected\n     */\n    this.isReplaced = undefined;\n    \n    /**\n     * @type {Object}\n     * @protected\n     */\n    this._childs = {};\n    \n    /**\n     * @type {Object.<string,Item>}\n     * @protected\n     */\n    this.childs = {};\n    \n    /**\n     * @type {Object.<string,Item>}\n     * @protected\n     */\n    this.parents = {};\n    \n    /**\n     * @type {EventEmitter}\n     * @public\n     */\n    this.emitter = new EventEmitter();\n    this.emitter.__emitToSubscription = function(subscription, eventType) {\n      var args = Array.prototype.slice.call(arguments, 2);\n      subscription.listener.apply(subscription.context, args);\n    };\n  }\n  \n  /**\n   * @param {LocalName} localName\n   * @param {GlobalName} globalName\n   * @param query\n   */\n  prepareChild(localName, globalName, query) {\n    var child = this.manager.get(globalName, query);\n    this._registerChild(localName, child);\n    return child;\n  }\n  \n  /**\n   * @param {LocalName} localName\n   * @param {Item} child\n   */\n  _registerChild(localName, child) {\n    this._childs[localName] = child;\n    this._childs[localName].emitter.once('replaced', (oldChild, newChild) => {\n      this._childReplaced(localName, oldChild, newChild);\n    });\n    this._childs[localName].emitter.once('unmounted', (error, child) => {\n      if (this._childs[localName] == child) this.childUnmounted(localName, child);\n    });\n    if (this.isMounted) child.mount();\n    else if (this.isPrepared) child.prepare((childError, child) => {\n      this._childPrepared(localName, childError, child);\n    });\n  }\n  \n  /**\n   * @param {LocalName} localName\n   * @param {Item} oldChild\n   * @param {Item} newChild\n   */\n  _childReplaced(localName, oldChild, newChild) {\n    if (!this.isPrepared || Object.keys(this._childs).length) this._registerChild(localName, newChild);\n    else this.childReplaced(localName, oldChild, newChild);\n  }\n  \n  /**\n   * @param {LocalName} localName\n   * @param {Item} oldChild\n   * @param {Item} newChild\n   * @description\n   * **must override**\n   */\n  childReplaced(localName, oldChild, newChild) {\n    throw new Error('Method childReplaced must be overrided.');\n  }\n  \n  /**\n   * @param {LocalName} localName\n   * @param {Item} child\n   * @description\n   * **must override**\n   */\n  childUnmounted(localName, child) {\n    throw new Error('Method childUnmounted must be overrided.');\n  }\n  \n  /**\n   * @param {Item~prepareCallback} [callback]\n   */\n  prepare(callback) {\n    if (this.isPrepared) {\n      if (callback) callback(this.error, this);\n    } else if(this.isPrepared === false) {\n      if (callback) this.emitter.once('prepared', callback);\n    } else {\n      this.isPrepared = false;\n      if (callback) this.emitter.once('prepared', callback);\n      this.preparation();\n    }\n  }\n  \n  /**\n   * @callback Item~prepareCallback\n   * @param [error]\n   * @param {Item} item\n   */\n  \n  /**\n   * @description\n   * **must override**\n   */\n  preparation() {\n    throw new Error('Method preparation must be overrided.');\n  }\n  \n  /**\n   * @fires Item#prepared\n   * @param [error]\n   */\n  prepared(error) {\n    if (!this.isPrepared && !this.isReplaced) {\n      this.isPrepared = true;\n      if (!error && Object.keys(this._childs).length) {\n        for (var c in this._childs) {\n          this._childs[c].prepare((childError, child) => {\n            this._childPrepared(c, childError, child);\n          });\n        }\n      } else {\n        this.emitter.emit('prepared', error, this);\n      }\n    }\n  }\n  \n  /**\n   * @event Item#prepared\n   * @param [error]\n   * @param {Item} item\n   */\n  \n  /**\n   * @param {LocalName} localName\n   * @param [childError]\n   * @param {Item} child\n   */\n  _childPrepared(localName, childError, child) {\n    this.childs[localName] = this._childs[localName];\n    delete this._childs[localName];\n    child.parents[this.index] = this;\n    if (!Object.keys(this._childs).length) {\n      this.emitter.emit('prepared', undefined, this);\n    }\n  }\n  \n  /**\n   * @param {GlobalName|Item} [nameOrItem]\n   * @param [query]\n   * @param [data]\n   * @returns {Item} - Other active item.\n   */\n  replace() {\n    if (this.isReplaced) {\n      return this.getActive();\n    } else this.isReplaced = true;\n    \n    var item;\n    if (!arguments.length) {\n      item = this.manager.get(this.name, this.query);\n      if (!item.isPrepared) {\n        item.data = this.data;\n      }\n    } else if (arguments.length == 1 && typeof(arguments[0]) == 'object' && arguments[0] instanceof this.manager._Item) {\n      item = arguments[0];\n    } else if (arguments.length >= 2) {\n      item = this.manager.get(arguments[0], arguments[1]);\n      if (arguments.length == 3 && !item.isPrepared) {\n        item.data = arguments[2];\n      }\n    } else throw new Error('invalid arguments for replace');\n    \n    this.replacedTo = item;\n    \n    this.emitter.emit('replaced', this, item);\n    return item;\n  }\n  \n  /**\n   * @event Item#replaced\n   * @param {Item} oldItem\n   * @param {Item} newItem\n   */\n  \n  getActive() {\n    if (this.replacedTo) {\n      if (this._getActiveCache) {\n        this._getActiveCache = this._getActiveCache.getActive();\n      } else {\n        this._getActiveCache = this.replacedTo.getActive();\n      }\n      return this._getActiveCache;\n    } else return this;\n  }\n  \n  /**\n   * @param {Item~mountCallback} [callback]\n   */\n  mount(callback) {\n    this.prepare((error, item) => {\n      if (this.isMounted) {\n        if (callback) callback(undefined, this);\n      } else if(this.isMounted === false) {\n        this.shouldMount(callback);\n      } else {\n        this.isMounted = false;\n        if (callback) this.emitter.once('mounted', callback);\n        this.mounting();\n      }\n    });\n  }\n  \n  /**\n   * @param {Item~unmountCallback} [callback]\n   * @description\n   * **can override**\n   */\n  shouldMount(callback) {\n    if (callback) callback(undefined, this);\n  }\n  \n  /**\n   * @callback Item~mountCallback\n   * @param [error]\n   * @param {Item} item\n   */\n  \n  /**\n   * @description\n   * **must override**\n   */\n  mounting(callback) {\n    throw new Error('Method mounting must be overrided.');\n  }\n  \n  /**\n   * @param {Item} parent\n   * @description\n   * **can override**\n   */\n  parentUnmounted(parent) {\n    this.unmount();\n  }\n  \n  /**\n   * @fires Item#mounted\n   * @param [error]\n   */\n  mounted(error) {\n    if (this.isPrepared && !this.isMounted && !this.isReplaced) {\n      this.isMounted = true;\n      this.emitter.emit('mounted', error, this);\n    }\n  }\n  \n  /**\n   * @event Item#mounted\n   * @param [error]\n   * @param {Item} item\n   */\n  \n  /**\n   * @param {Item~unmountCallback} [callback]\n   */\n  unmount(callback) {\n    if (this.isUnmounted) {\n      if (callback) callback(undefined, this);\n    } else if(this.isUnmounted === false) {\n      if (callback) this.emitter.once('unmounted', callback);\n    } else {\n      this.shouldUnmount(callback);\n    }\n  }\n  \n  /**\n   * @param {Item~unmountCallback} [callback]\n   * @description\n   * **can override**\n   */\n  shouldUnmount(callback) {\n    if (Object.keys(this.parents).length) {\n      if (callback) callback();\n    } else {\n      this.forceUnmount(callback);\n    }\n  }\n  \n  /**\n   * @param {Item~unmountCallback} [callback]\n   */\n  forceUnmount(callback) {\n    this.isUnmounted = false;\n    if (callback) this.emitter.once('unmounted', callback);\n    this.unmounting();\n  }\n  \n  /**\n   * @callback Item~unmountCallback\n   * @param [error]\n   * @param {Item} item\n   */\n  \n  /**\n   * @description\n   * **can ovveride**\n   */\n  unmounting() {\n    for (var c in this.childs) {\n      delete this.childs[c].parents[this.index];\n      this.childs[c].parentUnmounted(this);\n    }\n    this.unmounted(undefined);\n  }\n  \n  /**\n   * @fires Item#unmounted\n   * @param [error]\n   */\n  unmounted(error) {\n    if (!this.isUnmounted) {\n      this.isUnmounted = true;\n      this.emitter.emit('unmounted', error, this);\n    }\n  }\n}\n\nexport default Item;"]}