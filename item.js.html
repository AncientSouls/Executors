<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>item.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html">Item</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#_childPrepared">_childPrepared</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#_childReplaced">_childReplaced</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#_registerChild">_registerChild</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#childReplaced">childReplaced</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#childUnmounted">childUnmounted</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#forceUnmount">forceUnmount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#mount">mount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#mounted">mounted</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#mounting">mounting</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#parentUnmounted">parentUnmounted</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#preparation">preparation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#prepare">prepare</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#prepareChild">prepareChild</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#prepared">prepared</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#replace">replace</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#shouldMount">shouldMount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#shouldUnmount">shouldUnmount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#unmount">unmount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#unmounted">unmounted</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Item.html#unmounting">unmounting</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-ancient-funicular.Manager.html">Manager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ancient-funicular.Manager.html#get">get</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-ancient-funicular.html">ancient-funicular</a></span></li><li class="nav-heading">Events</li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Item.html#event:mounted">mounted</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Item.html#event:prepared">prepared</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Item.html#event:replaced">replaced</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">item.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var { EventEmitter } = require('fbemitter');

var counter = 1;

/**
 * @class
 * @memberof module:ancient-funicular
 */
class Item {
  
  /**
   * @constructs Item
   * @param {Manager} manager
   * @param {string} name
   * @param [query]
   */
  constructor(manager, name, query) {
    
    /**
     * @type {number}
     * @protected
     */
    this.index = counter++;
    
    /**
     * @type {Manager}
     * @protected
     */
    this.manager = manager;
    
    /**
     * @type {string}
     * @protected
     */
    this.name = name;
    
    /**
     * @protected
     */
    this.query = query;
    
    /**
     * @protected
     */
    this.data = undefined;
    
    /**
     * @type {boolean=}
     * @protected
     */
    this.isPrepared = undefined;
    
    /**
     * @type {boolean=}
     * @protected
     */
    this.isMounted = undefined;
    
    /**
     * @type {boolean=}
     * @protected
     */
    this.isUnmounted = undefined;
    
    /**
     * @type {boolean=}
     * @protected
     */
    this.isReplaced = undefined;
    
    /**
     * @type {Object}
     * @protected
     */
    this._childs = {};
    
    /**
     * @type {Object.&lt;string,Item>}
     * @protected
     */
    this.childs = {};
    
    /**
     * @type {Object.&lt;string,Item>}
     * @protected
     */
    this.parents = {};
    
    /**
     * @type {EventEmitter}
     * @public
     */
    this.emitter = new EventEmitter();
    this.emitter.__emitToSubscription = function(subscription, eventType) {
      var args = Array.prototype.slice.call(arguments, 2);
      subscription.listener.apply(subscription.context, args);
    };
  }
  
  /**
   * @param {LocalName} localName
   * @param {GlobalName} globalName
   * @param query
   */
  prepareChild(localName, globalName, query) {
    var child = this.manager.get(globalName, query);
    this._registerChild(localName, child);
    return child;
  }
  
  /**
   * @param {LocalName} localName
   * @param {Item} child
   */
  _registerChild(localName, child) {
    this._childs[localName] = child;
    this._childs[localName].emitter.once('replaced', (oldChild, newChild) => {
      this._childReplaced(localName, oldChild, newChild);
    });
    this._childs[localName].emitter.once('unmounted', (error, child) => {
      if (this._childs[localName] == child) this.childUnmounted(localName, child);
    });
    if (this.isMounted) child.mount();
    else if (this.isPrepared) child.prepare((childError, child) => {
      this._childPrepared(localName, childError, child);
    });
  }
  
  /**
   * @param {LocalName} localName
   * @param {Item} oldChild
   * @param {Item} newChild
   */
  _childReplaced(localName, oldChild, newChild) {
    if (!this.isPrepared || Object.keys(this._childs).length) this._registerChild(localName, newChild);
    else this.childReplaced(localName, oldChild, newChild);
  }
  
  /**
   * @param {LocalName} localName
   * @param {Item} oldChild
   * @param {Item} newChild
   * @description
   * **must override**
   */
  childReplaced(localName, oldChild, newChild) {
    throw new Error('Method childReplaced must be overrided.');
  }
  
  /**
   * @param {LocalName} localName
   * @param {Item} child
   * @description
   * **must override**
   */
  childUnmounted(localName, child) {
    throw new Error('Method childUnmounted must be overrided.');
  }
  
  /**
   * @param {Item~prepareCallback} [callback]
   */
  prepare(callback) {
    if (this.isPrepared) {
      if (callback) callback(this.error, this);
    } else if(this.isPrepared === false) {
      if (callback) this.emitter.once('prepared', callback);
    } else {
      this.isPrepared = false;
      if (callback) this.emitter.once('prepared', callback);
      this.preparation();
    }
  }
  
  /**
   * @callback Item~prepareCallback
   * @param [error]
   * @param {Item} item
   */
  
  /**
   * @description
   * **must override**
   */
  preparation() {
    throw new Error('Method preparation must be overrided.');
  }
  
  /**
   * @fires Item#prepared
   * @param [error]
   */
  prepared(error) {
    if (!this.isPrepared &amp;&amp; !this.isReplaced) {
      this.isPrepared = true;
      if (!error &amp;&amp; Object.keys(this._childs).length) {
        for (var c in this._childs) {
          this._childs[c].prepare((childError, child) => {
            this._childPrepared(c, childError, child);
          });
        }
      } else {
        this.emitter.emit('prepared', error, this);
      }
    }
  }
  
  /**
   * @event Item#prepared
   * @param [error]
   * @param {Item} item
   */
  
  /**
   * @param {LocalName} localName
   * @param [childError]
   * @param {Item} child
   */
  _childPrepared(localName, childError, child) {
    this.childs[localName] = this._childs[localName];
    delete this._childs[localName];
    child.parents[this.index] = this;
    if (!Object.keys(this._childs).length) {
      this.emitter.emit('prepared', undefined, this);
    }
  }
  
  /**
   * @param {GlobalName|Item} [nameOrItem]
   * @param [query]
   * @param [data]
   * @returns {Item} - Other active item.
   */
  replace() {
    if (this.isReplaced) {
      return this.getActive();
    } else this.isReplaced = true;
    
    var item;
    if (!arguments.length) {
      item = this.manager.get(this.name, this.query);
      if (!item.isPrepared) {
        item.data = this.data;
      }
    } else if (arguments.length == 1 &amp;&amp; typeof(arguments[0]) == 'object' &amp;&amp; arguments[0] instanceof this.manager._Item) {
      item = arguments[0];
    } else if (arguments.length >= 2) {
      item = this.manager.get(arguments[0], arguments[1]);
      if (arguments.length == 3 &amp;&amp; !item.isPrepared) {
        item.data = arguments[2];
      }
    } else throw new Error('invalid arguments for replace');
    
    this.replacedTo = item;
    
    this.emitter.emit('replaced', this, item);
    return item;
  }
  
  /**
   * @event Item#replaced
   * @param {Item} oldItem
   * @param {Item} newItem
   */
  
  getActive() {
    if (this.replacedTo) {
      if (this._getActiveCache) {
        this._getActiveCache = this._getActiveCache.getActive();
      } else {
        this._getActiveCache = this.replacedTo.getActive();
      }
      return this._getActiveCache;
    } else return this;
  }
  
  /**
   * @param {Item~mountCallback} [callback]
   */
  mount(callback) {
    this.prepare((error, item) => {
      if (this.isMounted) {
        if (callback) callback(undefined, this);
      } else if(this.isMounted === false) {
        this.shouldMount(callback);
      } else {
        this.isMounted = false;
        if (callback) this.emitter.once('mounted', callback);
        this.mounting();
      }
    });
  }
  
  /**
   * @param {Item~unmountCallback} [callback]
   * @description
   * **can override**
   */
  shouldMount(callback) {
    if (callback) callback(undefined, this);
  }
  
  /**
   * @callback Item~mountCallback
   * @param [error]
   * @param {Item} item
   */
  
  /**
   * @description
   * **must override**
   */
  mounting(callback) {
    throw new Error('Method mounting must be overrided.');
  }
  
  /**
   * @param {Item} parent
   * @description
   * **can override**
   */
  parentUnmounted(parent) {
    this.unmount();
  }
  
  /**
   * @fires Item#mounted
   * @param [error]
   */
  mounted(error) {
    if (this.isPrepared &amp;&amp; !this.isMounted &amp;&amp; !this.isReplaced) {
      this.isMounted = true;
      this.emitter.emit('mounted', error, this);
    }
  }
  
  /**
   * @event Item#mounted
   * @param [error]
   * @param {Item} item
   */
  
  /**
   * @param {Item~unmountCallback} [callback]
   */
  unmount(callback) {
    if (this.isUnmounted) {
      if (callback) callback(undefined, this);
    } else if(this.isUnmounted === false) {
      if (callback) this.emitter.once('unmounted', callback);
    } else {
      this.shouldUnmount(callback);
    }
  }
  
  /**
   * @param {Item~unmountCallback} [callback]
   * @description
   * **can override**
   */
  shouldUnmount(callback) {
    if (Object.keys(this.parents).length) {
      if (callback) callback();
    } else {
      this.forceUnmount(callback);
    }
  }
  
  /**
   * @param {Item~unmountCallback} [callback]
   */
  forceUnmount(callback) {
    this.isUnmounted = false;
    if (callback) this.emitter.once('unmounted', callback);
    this.unmounting();
  }
  
  /**
   * @callback Item~unmountCallback
   * @param [error]
   * @param {Item} item
   */
  
  /**
   * @description
   * **can ovveride**
   */
  unmounting() {
    for (var c in this.childs) {
      delete this.childs[c].parents[this.index];
      this.childs[c].parentUnmounted(this);
    }
    this.unmounted(undefined);
  }
  
  /**
   * @fires Item#unmounted
   * @param [error]
   */
  unmounted(error) {
    if (!this.isUnmounted) {
      this.isUnmounted = true;
      this.emitter.emit('unmounted', error, this);
    }
  }
}

export default Item;</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.4</a> on Thu Sep 07 2017 02:25:02 GMT+0300 (MSK) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
